name: Valide Code
on:
  push:
    branches: [master]
  workflow_dispatch:
  pull_request:
    branches: [master]
permissions:
  contents: read
  id-token: write
jobs:
  validate-web:
    name: Validate UI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./tools/web
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4.2.0
        name: Install pnpm
        with:
          version: 10
          run_install: false
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - name: Install ğŸ”§
        run: pnpm install
      - name: Build ğŸ”§
        run: pnpm build
      - name: Format ğŸ‘•
        run: |
          pnpm format
          pnpm lint
      - name: Unit Tests âœ”ï¸
        run: pnpm test:coverage

  validate-cli:
    name: Validate CLI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./tools/cli
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetches the entire history of the repository
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Check Formatting ğŸ‘•
        run: cargo fmt --all -- --check
      - name: Prepare public folder
        run: mkdir -p public
      - name: Clippy ğŸ”
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Build ğŸ”§
        run: cargo build --verbose
      - name: Test âœ”ï¸
        run: cargo test --verbose

  # e2e_tests:
  #   name: End-to-end Tests
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: pnpm/action-setup@v2
  #       name: Install pnpm
  #       with:
  #         version: 8
  #         run_install: false
  #     - name: Get pnpm store directory
  #       shell: bash
  #       run: |
  #         echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
  #     - uses: actions/cache@v3
  #       name: Setup pnpm cache
  #       with:
  #         path: ${{ env.STORE_PATH }}
  #         key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
  #         restore-keys: |
  #           ${{ runner.os }}-pnpm-store-
  #     - name: Install ğŸ”§
  #       run: pnpm install
  #     - name: Build ğŸ”§
  #       run: pnpm build
  #     - name: End-to-end Tests âœ”ï¸
  #       run: |
  #         npx playwright install --with-deps
  #         pnpm test:e2e
